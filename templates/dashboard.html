<!DOCTYPE html>
<html>
<head>
    <title>Monitor Systemu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .process-list-container { max-height: 500px; overflow-y: auto; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .refresh-btn { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">System Monitor</a>
        <div>
            {% if is_admin %}
                <a href="/settings" class="btn btn-outline-light btn-sm me-2">‚öôÔ∏è Ustawienia</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">Wyloguj</a>
            {% else %}
                <a href="/login" class="btn btn-primary btn-sm">Zaloguj siƒô</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-2">
            <div class="card border-start border-primary border-4 h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Czas Pracy</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_hours }} h</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-2">
            <div class="card border-start border-danger border-4 h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Blokad Dzisiaj</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ blocks_today }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-2">
            <div class="card border-start border-success border-4 h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Procesy</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ process_count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-2">
            <div class="card border-start border-warning border-4 h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">RAM (System)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ system_memory }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header fw-bold">Najd≈Çu≈ºej dzia≈ÇajƒÖce</div>
                <div class="card-body">
                    <canvas id="usageChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header fw-bold">Aktywno≈õƒá godzinowa</div>
                <div class="card-body">
                     <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header fw-bold">Najczƒô≈õciej blokowane</div>
                <div class="card-body">
                    <canvas id="blockedChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>Aktywne Procesy</span>
                    <div class="d-flex">
                        <input type="text" id="procSearch" class="form-control form-control-sm me-2" placeholder="Szukaj..." style="width: 150px;">
                        <button onclick="window.location.reload()" class="btn btn-sm btn-outline-secondary">Od≈õwie≈º</button>
                    </div>
                </div>
                <div class="card-body p-0 process-list-container">
                    <table class="table table-striped table-hover mb-0 align-middle" id="procTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Nazwa</th>
                                <th>RAM</th>
                                <th>CPU</th>
                                <th class="text-end">Akcja</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proc in live %}
                            <tr>
                                <td class="fw-bold text-truncate proc-name" style="max-width: 200px;">{{ proc['name'] }}</td>
                                <td><span class="badge bg-light text-dark border">{{ proc['mem'] }} MB</span></td>
                                <td>
                                    {% if proc['cpu'] > 10 %}
                                        <span class="fw-bold text-danger">{{ proc['cpu'] }}%</span>
                                    {% else %}
                                        <span class="text-muted">{{ proc['cpu'] }}%</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if is_admin %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmKill('{{ proc['name'] }}')">Zabij</button>
                                    {% else %}
                                        <span class="text-muted small" title="Wymagane logowanie">üîí</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center p-3">Brak danych.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold">
                    Ostatnie Blokady
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0 small">
                        <thead>
                            <tr>
                                <th>Proces</th>
                                <th>Data</th>
                                <th>Pow√≥d</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in blocked %}
                            <tr>
                                <td class="text-danger fw-bold">{{ log['process_name'] }}</td>
                                <td>{{ log['added_at'] }}</td>
                                <td>{{ log['reason'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="killForm" action="/kill_process" method="POST" style="display:none;">
    <input type="hidden" name="target_name" id="targetInput">
</form>

<script>
    // Filtr wyszukiwania proces√≥w
    document.getElementById('procSearch').addEventListener('keyup', function() {
        var input = this.value.toLowerCase();
        var rows = document.querySelectorAll('#procTable tbody tr');

        rows.forEach(function(row) {
            var nameCell = row.querySelector('.proc-name');
            if (nameCell) {
                var name = nameCell.textContent.toLowerCase();
                if (name.includes(input)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });

    function confirmKill(name) {
        if(confirm('Zako≈Ñczyƒá proces: ' + name + '?')) {
            document.getElementById('targetInput').value = name;
            document.getElementById('killForm').submit();
        }
    }

    new Chart(document.getElementById('usageChart'), {
        type: 'doughnut',
        data: {
            labels: {{ labels | tojson }},
            datasets: [{
                data: {{ data | tojson }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
            }]
        },
        options: { maintainAspectRatio: false, cutout: '70%' }
    });

    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: {{ hourly_labels | tojson }},
            datasets: [{
                label: 'Starty',
                data: {{ hourly_data | tojson }},
                backgroundColor: '#36b9cc'
            }]
        },
        options: { maintainAspectRatio: false }
    });

    new Chart(document.getElementById('blockedChart'), {
        type: 'pie',
        data: {
            labels: {{ top_blocked_labels | tojson }},
            datasets: [{
                data: {{ top_blocked_data | tojson }},
                backgroundColor: ['#e74a3b', '#fd7e14', '#f6c23e', '#858796', '#5a5c69']
            }]
        },
        options: { maintainAspectRatio: false }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>